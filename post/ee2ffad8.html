<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8" />

<meta name="generator" content="Hexo 3.9.0" />

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

<title>结合CVE-2019-1040漏洞的两种Windows域提权利方式 - Jon Tsang&#39;Blog</title>


    <meta name="description" content="2019年6月，Microsoft发布了一条安全更新。该更新针对CVE-2019-1040漏洞进行修复。此次漏洞，攻击者可以通过中间人攻击，绕过NTLM MIC（消息完整性检查）保护，将身份验证流量中继到目标服务器。通过这种攻击使得攻击者在仅有一个普通域账号的情况下可以远程控制 Windows 域内的任何机器，包括域控服务器。 本文主要介绍了利用该漏洞实现Windows域提权的两种方式。">
<meta name="keywords" content="提权,Windows,漏洞,NTML">
<meta property="og:type" content="article">
<meta property="og:title" content="结合CVE-2019-1040漏洞的两种Windows域提权利方式">
<meta property="og:url" content="https://jontsang.github.io/post/ee2ffad8.html">
<meta property="og:site_name" content="Jon Tsang&#39;Blog">
<meta property="og:description" content="2019年6月，Microsoft发布了一条安全更新。该更新针对CVE-2019-1040漏洞进行修复。此次漏洞，攻击者可以通过中间人攻击，绕过NTLM MIC（消息完整性检查）保护，将身份验证流量中继到目标服务器。通过这种攻击使得攻击者在仅有一个普通域账号的情况下可以远程控制 Windows 域内的任何机器，包括域控服务器。 本文主要介绍了利用该漏洞实现Windows域提权的两种方式。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190823152030.jpg">
<meta property="og:updated_time" content="2019-08-25T12:19:24.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="结合CVE-2019-1040漏洞的两种Windows域提权利方式">
<meta name="twitter:description" content="2019年6月，Microsoft发布了一条安全更新。该更新针对CVE-2019-1040漏洞进行修复。此次漏洞，攻击者可以通过中间人攻击，绕过NTLM MIC（消息完整性检查）保护，将身份验证流量中继到目标服务器。通过这种攻击使得攻击者在仅有一个普通域账号的情况下可以远程控制 Windows 域内的任何机器，包括域控服务器。 本文主要介绍了利用该漏洞实现Windows域提权的两种方式。">
<meta name="twitter:image" content="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190823152030.jpg">







<link rel="icon" href="/images/favicon.svg">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/font-awesome/5.4.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.loli.net/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    
        <script async="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    

    


<link rel="stylesheet" href="/css/style.css">
</head>
<!-- <body class="is-2-column"> -->
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/logo.svg" alt="结合CVE-2019-1040漏洞的两种Windows域提权利方式" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                    
                    
                    <a class="navbar-item" target="_blank" title="Download on GitHub" href="https://github.com/JonTsang">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                    
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <div class="column is-8-tablet is-8-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-image">
        <span  class="image is-7by1">
            <img class="thumbnail" src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190823152030.jpg" alt="结合CVE-2019-1040漏洞的两种Windows域提权利方式">
        </span>
    </div>
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">
                <time class="level-item has-text-grey" datetime="2019-07-01T14:21:33.000Z">2019-07-01</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/漏洞分析/">漏洞分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    40 分钟 读完 (大约 6054 个字)
                </span>
                
                
                <span class="level-item has-text-grey" id="busuanzi_container_page_pv">
                    <i class="far fa-eye"></i>
                    <span id="busuanzi_value_page_pv">0</span>次访问
                </span>
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                结合CVE-2019-1040漏洞的两种Windows域提权利方式
            
        </h1>
        <div class="content">
            <p>2019年6月，Microsoft发布了一条安全更新。该更新针对CVE-2019-1040漏洞进行修复。此次漏洞，攻击者可以通过中间人攻击，绕过NTLM MIC（消息完整性检查）保护，将身份验证流量中继到目标服务器。通过这种攻击使得攻击者在仅有一个普通域账号的情况下可以远程控制 Windows 域内的任何机器，包括域控服务器。</p>
<p>本文主要介绍了利用该漏洞实现Windows域提权的两种方式。</p>
<a id="more"></a>

<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><h3 id="攻击方式一：利用Exchange"><a href="#攻击方式一：利用Exchange" class="headerlink" title="攻击方式一：利用Exchange"></a>攻击方式一：利用Exchange</h3><p><strong>测试环境：</strong></p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>系统版本</strong></th>
<th><strong>计算机名</strong></th>
<th><strong>IP地址</strong></th>
<th><strong>域</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Attacker</td>
<td>Ubuntu Server 18.04</td>
<td>ubuntu</td>
<td>192.168.123.69</td>
<td></td>
</tr>
<tr>
<td>DC</td>
<td>Windows Server 2012 R2</td>
<td>topsec-dc</td>
<td>192.168.123.150</td>
<td>test.local</td>
</tr>
<tr>
<td>Exchange</td>
<td>Windows Server 2012 R2</td>
<td>topsec</td>
<td>192.168.123.143</td>
<td>test.local</td>
</tr>
</tbody></table>
<p><strong>测试过程：</strong></p>
<ol>
<li>环境搭建</li>
</ol>
<ul>
<li><p>安装配置域控制器</p>
</li>
<li><p>安装配置Exchange Server，参考：<a href="https://www.cnblogs.com/jianyus/p/3170732.html" target="_blank" rel="noopener">Exchange Server 2013 一步步安装图解</a></p>
</li>
<li><p>在域中新建一个用于测试的账户test</p>
</li>
</ul>
<ol start="2">
<li>执行ntlmrelayx.py脚本进行NTLM中继攻击，设置SMB服务器并将认证凭据中继到LDAP协议。其中<strong>–remove-mic</strong>选项用于清除MIC标志，<strong>–escalate-user</strong>用于提升指定用户权限。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190400.png" alt></p>
<ol start="3">
<li>执行printerbug.py脚本，触发SpoolService的bug。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190420.png" alt></p>
<ol start="4">
<li>SpoolService的bug导致Exchange服务器回连到ntlmrelayx.py，即将认证信息发送到ntlmrelayx.py。可以在下图中看到认证用户是TEST\TOPSEC$。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190630.png" alt></p>
<p>接着ntlmrelayx.py开始执行LDAP攻击，加上-debug选项后可以看到更详细的信息。</p>
<p>首先，通过遍历验证中继帐户所在用户组及权限，发现当前账户可以创建用户、可以修改test.local域的ACL，因为域中的Exchange Windows Permissions用户组被允许修改ACL，如下图所示：</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190634.png" alt></p>
<p>该用户组下的成员正是中继的计算机账户TOPSEC</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190626.png" alt></p>
<p>因此脚本会首选修改ACL来提权，因为这相比创建用户的方式更隐秘一些。具体方式是通过LDAP修改域的安全描述符（Security Descriptor），可以在下面的数据包中看到ACL中每一条具体的访问控制条目（ACE，Access Control Entries）：</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190629.png" alt></p>
<ol start="5">
<li>完成ACL的修改后，test就可以通过secretsdump.py的DCSync功能dump出所有密码哈希值：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190633.png" alt></p>
<h3 id="攻击方式二：利用Kerberos委派"><a href="#攻击方式二：利用Kerberos委派" class="headerlink" title="攻击方式二：利用Kerberos委派"></a>攻击方式二：利用Kerberos委派</h3><p><strong>测试环境：</strong></p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>系统版本</strong></th>
<th><strong>计算机名</strong></th>
<th><strong>IP**</strong>地址**</th>
<th><strong>域</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Attacker</td>
<td>Ubuntu Server 18.04</td>
<td>ubuntu</td>
<td>192.168.123.69</td>
<td></td>
</tr>
<tr>
<td>DC</td>
<td>Windows Server 2012 R2</td>
<td>topsec-dc</td>
<td>192.168.123.212</td>
<td>test.local</td>
</tr>
<tr>
<td>SDC</td>
<td>Windows Server 2012 R2</td>
<td>topsec</td>
<td>192.168.123.62</td>
<td>test.local</td>
</tr>
</tbody></table>
<p><strong>测试过程：</strong></p>
<ol>
<li>环境搭建</li>
</ol>
<ul>
<li>安装配置域控制器，同时开启LDAPS支持，因为该攻击方式需要添加新的计算机账户，必须在LDAPS进行。开启方法参考：<a href="https://gist.github.com/magnetikonline/0ccdabfec58eb1929c997d22e7341e45" target="_blank" rel="noopener">Enable LDAP over SSL (LDAPS) for Microsoft Active Directory servers</a></li>
<li>安装配置辅助域控制器，参考： <a href="http://www.mamicode.com/info-detail-2275954.html" target="_blank" rel="noopener">Windows Server 2012 R2 辅助域控制器搭建</a></li>
<li>在域中新建一个用于测试的账户topsec，一个域管理员admin</li>
</ul>
<ol start="2">
<li>和攻击方式一相同，执行ntlmrelayx.py本，使用<strong>–delegate-access</strong>选项，将中继计算机帐户（这里即辅助域控制器）的访问权限委托给attacker。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825192259.png" alt></p>
<ol start="3">
<li>attacker对辅助域控制器(SDC)执行printerbug.py脚本</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190420.png" alt></p>
<ol start="4">
<li><p>printerbug.py脚本执行成功后，将触发辅助域控制器(SDC)回连Attacker主机，回连使用的认证用户是辅助域控制器(SDC)本地计算机账户TEST/TOPSEC$。</p>
<p>ntlmrelayx.py通过ldaps将该用户账户中继到域控服务器(DC)，因为这种攻击方式下所冒用的身份<strong>TEST/TOPSEC$</strong>并不在Exchange Windows Permissions组内，不具有修改ACL权限，但是可以通过此身份在DC上添加一个新计算机账户（下图中<strong>EJETBTTB$</strong>）, 并修改其约束委派授权，授予它对受害计算机（辅助域控制器）的委派权限。</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190631.png" alt></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190625.png" alt></p>
<ol start="5">
<li>使用getSP.py脚本，通过-impersonate参数模拟用户admin请求其票证，保存为ccache，admin用户为Domain Admins组的成员，具有对辅助域控制器(SDC)的管理与访问权限。</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190627.png" alt></p>
<ol start="6">
<li>使用上一步骤中保存的Kerberos服务票证，我们可以在目标主机(SDC)上模拟admin身份，从而执行任何操作，例如使用secretsdump转储哈希值。通过secretsdump dump出所有密码哈希值：</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190632.png" alt></p>
<h2 id="攻击流程和技术细节"><a href="#攻击流程和技术细节" class="headerlink" title="攻击流程和技术细节"></a>攻击流程和技术细节</h2><p>以上就是利用CVE-2019-1040进行攻击的两种方式，这里做一下总结：</p>
<p>1、 Exchange攻击流程：使用任何AD帐户，通过SMB连接到目标Exchange服务器，并触发SpoolService错误。目标服务器将通过SMB回连至攻击者主机，使用ntlmrelayx将SMB身份验证中继到LDAP。使用中继的LDAP身份验证，为攻击者帐户授予DCSync权限。攻击者帐户使用DCSync转储AD中的所有密码哈希值。</p>
<p>2、 Kerberos委派攻击流程：使用任何AD帐户，通过SMB连接到目标服务器，并触发SpoolService错误。目标服务器将通过SMB回连至攻击者主机，使用ntlmrelayx将SMB身份验证中继到LDAP。使用中继的LDAP身份验证，将目标服务器的基于资源的约束委派权限授予攻击者控制下的计算机帐户。攻击者作为受害者服务器上的任何用户进行身份验证。</p>
<p>接下来详细介绍整个攻击流程和细节</p>
<h3 id="Exchange攻击流程细节"><a href="#Exchange攻击流程细节" class="headerlink" title="Exchange攻击流程细节"></a>Exchange攻击流程细节</h3><p> 下文出现的攻击流量图中，各角色与IP对应关系同上文<strong>测试环境</strong>：</p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>系统版本</strong></th>
<th><strong>计算机名</strong></th>
<th><strong>IP**</strong>地址**</th>
<th><strong>域</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Attacker</td>
<td>Ubuntu Server 18.04</td>
<td>ubuntu</td>
<td>192.168.123.69</td>
<td></td>
</tr>
<tr>
<td>DC</td>
<td>Windows Server 2012 R2</td>
<td>topsec-dc</td>
<td>192.168.123.150</td>
<td>test.local</td>
</tr>
<tr>
<td>Exchange</td>
<td>Windows Server 2012 R2</td>
<td>topsec</td>
<td>192.168.123.143</td>
<td>test.local</td>
</tr>
</tbody></table>
<p>如果对SMB协议不是很清楚，可以先参考<strong>技术点分析-客户端与服务器端的SMB通信</strong>一节内容</p>
<ol>
<li>attacker使用普通AD账户登陆Exchange</li>
</ol>
<p>在攻击的开始阶段，attacker需要确保拥有一个可使用的AD账号，这是满足触发SpoolService错误的必要条件。</p>
<p>首先attacker利用已拥有的AD账号，连接到远程服务器的打印服务（spoolsv.exe）。</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825190926.png" alt="Attacker通过SMB2协议登陆Exchange流量"> </p>
<p>成功的通过该阶段，就可以请求对一个新的打印作业进行更新，令其将该通知发送给指定目标。</p>
<ol start="2">
<li>触发SpoolService错误</li>
</ol>
<p>attacker通过Printerbug脚本，触发Exchange服务器SpoolService错误，强制Exchange服务器通过MS-RPRN RPC接口向attacker进行身份验证。具体细节见<strong>技术点分析</strong>一章中的<strong>SpoolService/printer bug</strong></p>
<ol start="3">
<li>Exchange主机向Attacker发送Negotiate Protocol Request</li>
</ol>
<p>在触发SpoolService错误后，Exchange服务器向Attacker进行身份验证</p>
<p>Exchange服务器向Attacker发送Negotiate Protocol Request，这是客户端向服务器发送第一个SMB请求，可<strong>参考技术点分析-客户端与服务器端的SMB通信</strong></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825191100.png" alt="Exchange向Attacker发送SMB协商请求流量"></p>
<p>在正常的业务场景中，用户想登陆并使用Exchange，往往需要向Exchange服务器发送SMB协商请求流量，以便验证身份并登陆。但由于SpoolService错误，在这里，Exchange向Attacker发送SMB协商请求流量，以便验证身份。这便造成了Attacker可以作为中间人身份中继此身份认证以冒充Exchange欺骗DC的机会。</p>
<ol start="4">
<li>Attacker将协商请求通过ldap中继到DC服务器</li>
</ol>
<p>在此步骤以及以下攻击流程中，有需要将SMB身份验证通过LDAP中继至DC的环节。由于NTLM协议的工作方式，无法将SMB流量直接通过LDAP中继，因此需要对流量进行修改，而需改流量，势必需要绕过MIC验证，此处便是本次漏洞的重点，详情见 <strong>技术点分析-MIC校验绕过</strong>部分</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825191212.png" alt="Attacker向DC中继Exchange的协商请求流量"> </p>
<ol start="5">
<li>attacker向Exchange发送Negotiate Protocol Response</li>
</ol>
<p>Attacker作为中间人，将Negotiate Protocol Request通过ldap请求中继到ad服务器</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825194205.png" alt="Attacker向Exchange发送Negotiate Protocol Response流量"></p>
<ol start="6">
<li>Exchange向attacker发送Session Setup Request</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825194241.png" alt="Exchange向attacker发送Session Setup Request流量"></p>
<ol start="7">
<li>Attacker向DC中继Session Setup Request</li>
</ol>
<p>Attacker将Exchange发送来的Session Setup Request 中继给DC， DC将包含 CHALLENGE的Response发送给Attacker</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825191551.png" alt="Attacker向DC中继Session Setup Request流量"></p>
<ol start="8">
<li>Attacker 向exchange发送Session Setup Response（CHALLENGE）</li>
</ol>
<p>Attacker 将DC发出的包含challenge的Session Setup Response发送给exchange </p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825192941.png" alt="Attacker 向exchange发送Session Setup Response流量"></p>
<ol start="9">
<li>exchange向Attacker发送包含了身份验证请求的Session Setup </li>
</ol>
<p>我们可以看到下图中的认证用户为<strong>TEST\TOPSEC$</strong>，而不是运行Exchange的SYSTEM账户，这是因为SYSTEM账户具有太高权限，如果用此帐户对网络资源进行身份验证，则会出现安全问题。所以当访问网络资源时，使用本地计算机的网络帐户对网络进行身份验，（形式为<strong>domain\computername$</strong>，即<strong>TEST\TOPSEC$</strong>）</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825193029.png" alt="exchange向Attacker发送包含了身份验证请求的Session Setup流量"></p>
<ol start="10">
<li>Attacker向 DC中继含有Exchange的身份认证的Session Setup Request</li>
</ol>
<p>Attacker将身份认证请求中继到DC，并使用Exchange的身份认证通过DC认证，DC认证通过Exchange身份，并向Attcker发送认证通过的Response</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825191757.png" alt="Attacker向 DC中继Session Setup Request 流量"></p>
<p>此时，DC对Attacker的身份验证结束，Attacker成功冒用Exchange身份，整个流程如下图：</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825193124.png" alt></p>
<p>由于安装Exchange后，Exchange在Active Directory域中具有高权限，Exchange的本地计算机账户TOPSEC$会被加入用户组Exchange Trusted Subsystem，该用户组又隶属于Exchange Windows Permissions。Exchange Windows Permissions组可以通过WriteDacl方式访问Active Directory中的Domain对象，该对象允许该组的任何成员修改域权限，从而可以修改当前域ACL达到提权目的。</p>
<p>使用提权后的用户或计算机可以执行域控制器通常用于复制的同步操作，这允许攻击者同步Active Directory中用户的所有哈希密码。</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825191820.png" alt="同步Active Directory中用户的所有哈希密码"></p>
<h3 id="Kerberos委派攻击流程"><a href="#Kerberos委派攻击流程" class="headerlink" title="Kerberos委派攻击流程"></a>Kerberos委派攻击流程</h3><p> 下文出现的攻击流量图中，各角色与IP对应关系同上文<strong>测试环境</strong>：</p>
<table>
<thead>
<tr>
<th><strong>角色</strong></th>
<th><strong>系统版本</strong></th>
<th><strong>计算机名</strong></th>
<th><strong>IP**</strong>地址**</th>
<th><strong>域</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Attacker</td>
<td>Ubuntu Server 18.04</td>
<td>ubuntu</td>
<td>192.168.123.69</td>
<td></td>
</tr>
<tr>
<td>DC</td>
<td>Windows Server 2012 R2</td>
<td>topsec-dc</td>
<td>192.168.123.212</td>
<td>test.local</td>
</tr>
<tr>
<td>SDC</td>
<td>Windows Server 2012 R2</td>
<td>topsec</td>
<td>192.168.123.62</td>
<td>test.local</td>
</tr>
</tbody></table>
<p>Kerberos委派攻击流程与Exchange攻击利用，在DC对Attacker的身份验证结束之前的阶段是类似的。区别在于后续提权过程，下面介绍下Kerberos委派攻击后续攻击流程。</p>
<p>在attacker冒用SDC身份后，由于SDC计算机身份没有修改访问控制列表(ACL)的权限，无法直接提权。而后续提权利用中的S4U2Self不适用于没有SPN的帐户。在域环境中，任何域用户都可以通过MachineAccountQuota创建新的计算机帐户，并为其设置SPN。Attacker通过此方式新建一个域中的计算机账号。这一过程通过LDAP实现并设置账户与密码 ，如下图</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825192025.png" alt></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825194423.png" alt> </p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825194454.png" alt="Ntlmrelayx工具成功创建计算机账户"></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190824190625.png" alt="DC上可见computers列表中新创建的名为EJETBTTB的计算机"></p>
<p>在域中新的计算机账户EJETBTTB(下图中的service A)建立成功后，后续攻击如下图攻击步骤</p>
<p><img src="/Users/zengyongrui/Pictures/Markdown/clip_image040.png" alt="img"></p>
<p>攻击步骤</p>
<ol>
<li>攻击者为Service A配置了基于资源的约束委派</li>
</ol>
<p>由于通过S4U2Self请求到的TGS forwardable标志位为 Non-forwardable,这意味着该TGS服务票据是不可转发的，不可以在接下来的S4U2Proxy中进行转发。但是不可转发的TGS竟然可以用于基于资源的约束委派，S4U2Proxy会接收这张不可转发的TGS。由于我们拥有Service A的计算机账号以及密码，所以在这里可以为Service A到SDC配置了基于资源的约束委派，将默认的约束委派更改为基于资源的约束委派，以便后续攻击。</p>
<ol start="2">
<li>Service A 调用S4U2Self向认证服务器(SDC)为admin请求访问自身的服务票据. </li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825194955.png" alt></p>
<p>通过国外安全研究员Elad Shami的研究可知，无论服务账号的<em>UserAccountControl</em>属性是否被设为<em>TrustedToAuthForDelegation</em>， 服务自身都可以调用S4U2Self为任意用户请求访问自己的服务票据，也就是说，这里Service A 可以调用S4U2Self向SDC为admin用户申请可访问自身的服务票据.</p>
<ol start="3">
<li>SDC将为admin用户申请的访问Service A的TGS发送给Service A</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195018.png" alt></p>
<p>4、 Service A通过S4U2Proxy 转发TGS，并为admin申请访问SDC票据</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195030.png" alt></p>
<p>5、SDC将为admin用户申请的访问SDC的TGS发送给Service A</p>
<p>在这里，Service A为Attacker创建并控制，Attacker获得TGS票据，利用该票据以admin身份访问SDC，完成提权</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195041.png" alt></p>
<h3 id="技术点分析"><a href="#技术点分析" class="headerlink" title="技术点分析"></a>技术点分析</h3><p>在理清利用流程后，接下来详解利用流程中的技术点</p>
<h4 id="客户端与服务器端的SMB通信"><a href="#客户端与服务器端的SMB通信" class="headerlink" title="客户端与服务器端的SMB通信"></a>客户端与服务器端的SMB通信</h4><p>补充介绍一些关于SMB通信协议相关内容，通过这部分内容，可以加深对的漏洞流程的理解。对SMB通信协议熟悉的读者，可以跳过此部分</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195059.png" alt="客户端与服务器端的SMB通信流程"></p>
<p><strong>SMB2 / Negotiate Protocol</strong></p>
<p>Negotiate Protocol是在SMB2的任何新TCP会话上发出的第一个SMB2命令，它用于协商要使用的协议版本。</p>
<p>Negotiate Protocol命令分为Negotiate Protocol Request/ Negotiate Protocol Response两部分：</p>
<ol>
<li><p>Negotiate Protocol Request： 客户端向服务器发送第一个SMB请求：“Negotiate Protocol Request”。这个请求包含了客户端所支持的各种 SMB Dialect。</p>
</li>
<li><p>Negotiate Protocol Response: 服务器收到该请求后，选择一个它支持的最新版本（比如NTLM 0.12），再通过“Negotiate Protocol Response”回复给客户端。</p>
<p><strong>SMB2 / Session Setup</strong></p>
</li>
</ol>
<p>SMB2 / Session Setup命令用于对用户进行身份验证并获取分配的UserID。此命令通常是SMB2 / Negotiate Protocol阶段完成后从客户端发出的第一个命令。</p>
<p>Session Setup分为两部分：</p>
<ol>
<li><p>Session Setup Request: Negotiate Protocol阶段结束之后，，客户端请求和服务器建立一个session，在客户端发送的Session Setup Request里，包含了身份验证请求。</p>
</li>
<li><p>Session Setup Response: 服务器回复是否通过验证。</p>
</li>
</ol>
<h4 id="SpoolService-printer-bug"><a href="#SpoolService-printer-bug" class="headerlink" title="SpoolService/printer bug"></a>SpoolService/printer bug</h4><p>在攻击利用流程中，需要使用到一个名为printerbug.py的工具，此工具触发SpoolService/printer bug，强制Windows主机通过MS-RPRN RPC接口向攻击者进行身份验证。</p>
<p>Windows的MS-RPRN协议用于打印客户机和打印服务器之间的通信，默认情况下是启用的。协议定义的RpcRemoteFindFirstPrinterChangeNotificationEx()调用创建一个远程更改通知对象，该对象监视对打印机对象的更改，并将更改通知发送到打印客户端。</p>
<p>任何经过身份验证的域成员都可以连接到远程服务器的打印服务（spoolsv.exe），并请求对一个新的打印作业进行更新，令其将该通知发送给指定目标。之后它会将立即测试该连接，即向指定目标进行身份验证（攻击者可以选择通过Kerberos或NTLM进行验证）。另外微软表示这个bug是系统设计特点，无需修复。</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825192408.png" alt></p>
<p> 在本次漏洞的利用过程中，我们通过printerbug.py脚本触发了上述bug，强制Exchange服务器对攻击者（192.168.123.69）发起身份验证，而Exchange默认是以SYSTEM身份执行的。</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825192425.png" alt></p>
<p>下图是printerbug.py执行后的数据包：</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195208.png" alt></p>
<ol>
<li><p>第一次身份验证由攻击者向exchange服务器发起，以便可以远程连接到Spoolsv服务，可以看到使用的账号是一个普通的域成员账号test；</p>
</li>
<li><p>接着，printerbug.py脚本中调用RpcRemoteFindFirstPrinterChangeNotificationEx()，请求对一个新的打印作业进行更新，并令其将该通知发送给我们指定的attackerhost（192.168.123.69）。这部分数据就是上图中Encrypted SMB3中的一部分。</p>
</li>
</ol>
<p><img src="/Users/zengyongrui/Pictures/Markdown/clip_image049.png" alt="img"></p>
<ol start="3">
<li>第二次身份验证便是使Exchange向attackerhost（192.168.123.69）发起的身份验证，用户为<strong>TEST\TOPSEC$</strong>，（不是SYSTEM的原因是：如果本地服务使用SYSTEM帐户访问网络资源，则使用本地计算机的网络帐户<strong>domain\computername$</strong>对网络进行身份验证）</li>
</ol>
<h4 id="SMB中继LDAP思路以及难点"><a href="#SMB中继LDAP思路以及难点" class="headerlink" title="SMB中继LDAP思路以及难点"></a>SMB中继LDAP思路以及难点</h4><p>在攻击利用流程中，需要将SMB身份验证通过LDAP中继至DC，由于NTLM协议的工作方式，无法将SMB流量直接通过LDAP中继，将SMB流量通过LDAP中继难点以及绕过思路如下：</p>
<p>1、 默认情况下，SMB中的NTLM身份验证:NEGOTIATE_SIGN为set状态</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825192451.png" alt></p>
<p>2、 将此SMB流量中继到LDAP时，由于此时的Negotiate Sign设置为set，该标志会触发LDAP签名，而此SMB流量为Attacker从Exchange服务器上中继而来，无法通过LDAP的签名校验，从而被LDAP忽略，导致攻击失败</p>
<p>3、 为了防止攻击失败，需要将NEGOTIATE_SIGN设置为Not set</p>
<p>4、 MIC保护不被篡改，如果简单的改包，将NEGOTIATE_SIGN设置Not set，将会导致MIC校验不通过</p>
<p>5、 需要寻找一种可以绕过MIC校验的方式，以便更改包中的值</p>
<p>6、 在绕过MIC校验之后，更改NEGOTIATE_SIGN值为Not set，使得在不触发LDAP签名校验的情况下，将SMB中继LDAP</p>
<h4 id="MIC校验"><a href="#MIC校验" class="headerlink" title="MIC校验"></a>MIC校验</h4><p>NTLM身份验证由3种消息类型组成：</p>
<p>NTLM_NEGOTIATE，NTLM_CHALLENGE，NTLM_AUTHENTICATE。</p>
<p>NTLM_NEGOTIATE，NTLM_CHALLENGE，NTLM_AUTHENTICATE对应位于SMB协议中的SessionSetup阶段</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195313.png" alt></p>
<p>Clinet与Server交互流程图</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825192502.png" alt="Clinet与Server交互流量"></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195328.png" alt="SMB认证协议流程"> </p>
<p>为了确保恶意行为者不在传输过程中处理消息，在NTLM_AUTHENTICATE消息中添加了一个额外的MIC（消息完整性代码）字段。</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195417.png" alt="存放于NTLM_AUTH中的MIC"></p>
<p>MIC是使用会话密钥应用于所有3个NTLM消息的串联的HMAC_MD5，该会话密钥仅对启动认证的帐户和目标服务器是已知的。</p>
<p>因此，试图篡改其中一条消息的攻击者（例如，修改签名协商）将无法生成相应的MIC，这将导致攻击失败。</p>
<h4 id="MIC校验绕过"><a href="#MIC校验绕过" class="headerlink" title="MIC校验绕过"></a>MIC校验绕过</h4><p>Microsoft服务器允许无MIC 的NTLM_AUTHENTICATE消息。</p>
<p>如果想要将SMB身份验证中继到LDAP，并完成中继攻击，可以通过如下步骤：</p>
<p>取消MIC校验以确保可以修改数据包中的内容：</p>
<ol>
<li><p>从NTLM_AUTHENTICATE消息中删除MIC</p>
</li>
<li><p>从NTLM_AUTHENTICATE消息中删除版本字段（删除MIC字段而不删除版本字段将导致错误）。</p>
</li>
</ol>
<h4 id="LDAP签名绕过"><a href="#LDAP签名绕过" class="headerlink" title="LDAP签名绕过"></a>LDAP签名绕过</h4><p>在绕过MIC校验之后，可以修改NEGOTIATE_SIGN值以便将SMB流量顺利通过LDAP签名校验</p>
<p>将NEGOTIATE_SIGN设置为not set以绕过LDAP验证</p>
<ol>
<li>取消设置NTLM_NEGOTIATE消息中的签名标志（NTLMSSP_NEGOTIATE_ALWAYS_SIGN，NTLMSSP_NEGOTIATE_SIGN</li>
<li>取消设置NTLM_AUTHENTICATE消息中的以下标志：NTLMSSP_NEGOTIATE_ALWAYS_SIGN，NTLMSSP_NEGOTIATE_SIGN，NEGOTIATE_KEY_EXCHANGE，NEGOTIATE_VERSION。</li>
</ol>
<h4 id="smb中继LDAP流程"><a href="#smb中继LDAP流程" class="headerlink" title="smb中继LDAP流程"></a>smb中继LDAP流程</h4><p>为了实现SMB中继LDAP流程，这里使用ntlmrelayx.py工具作为中继</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195503.jpg" alt> </p>
<p>Ntlmrelayx中继流程如下：</p>
<ol>
<li>取消设置NTLM_NEGOTIATE消息中的签名标志（NTLMSSP_NEGOTIATE_ALWAYS_SIGN，NTLMSSP_NEGOTIATE_SIGN）</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195530.png" alt="Exchange-Attacker-DC交互流量"></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195535.png" alt="Exchange向Attacker发送NTLMSSP_NEGOTIATE包内容"> </p>
<p>可见，在通过LDAP中继时，已经取消设置NTLM_NEGOTIATE消息中的签名标志（NTLMSSP_NEGOTIATE_ALWAYS_SIGN，NTLMSSP_NEGOTIATE_SIGN）</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195538.png" alt="Attacker将NTLMSSP_NEGOTIATE通过LDAP中继到DC包内容"></p>
<ol start="2">
<li>从NTLM_AUTHENTICATE消息中删除MIC以及版本字段</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195646.png" alt="Exchange-Attacker-DC交互流量"></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195649.png" alt="![](https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195656.png)"> </p>
<p> 在通过LDAP中继时，NTLM_AUTHENTICATE消息中MIC以及版本字段已被删除</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195651.png" alt="Attacker将NTLMSSP_AUTH通过LDAP中继到DC"></p>
<ol start="3">
<li>取消设置NTLM_AUTHENTICATE消息中的以下标志：NTLMSSP_NEGOTIATE_ALWAYS_SIGN，NTLMSSP_NEGOTIATE_SIGN，NEGOTIATE_KEY_EXCHANGE，NEGOTIATE_VERSION</li>
</ol>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195849.png" alt="Exchange-Attacker-DC交互流量"></p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195653.png" alt="Exchange向Attacker发送NTLMSSP_AUTH包内容"></p>
<p>在通过LDAP中继时， NTLM_AUTHENTICATE消息中的以下标志：NTLMSSP_NEGOTIATE_ALWAYS_SIGN，NTLMSSP_NEGOTIATE_SIGN，NEGOTIATE_KEY_EXCHANGE，NEGOTIATE_VERSION已经被设置为’NOT set’</p>
<p><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190825195656.png" alt="Attacker将NTLMSSP_AUTH通过LDAP中继到DC包内容"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p>[1] <a href="https://www.cnblogs.com/jianyus/p/3170732.html" target="_blank" rel="noopener">Exchange Server 2013 一步步安装图解</a></p>
<p>[2] <a href="https://gist.github.com/magnetikonline/0ccdabfec58eb1929c997d22e7341e45" target="_blank" rel="noopener">Enable LDAP over SSL (LDAPS) for Microsoft Active Directory servers</a></p>
<p>[3] <a href="http://www.mamicode.com/info-detail-2275954.html" target="_blank" rel="noopener">Windows Server 2012 R2 辅助域控制器搭建</a></p>
<p>[4] <a href="https://www.cnblogs.com/backlion/p/10537813.html" target="_blank" rel="noopener">滥用基于资源约束委派来攻击Active Directory</a></p>
<p>[5] <a href="https://alsid.com/company/news/abusing-s4u2self-another-sneaky-active-directory-persistence" target="_blank" rel="noopener">Abusing S4U2Self: Another Sneaky Active Directory Persistence</a></p>
<p>[6] <a href="https://dirkjanm.io/exploiting-CVE-2019-1040-relay-vulnerabilities-for-rce-and-domain-admin/" target="_blank" rel="noopener">利用CVE-2019-1040 - 结合RCE和Domain Admin的中继漏洞</a></p>
<p>[7] <a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/" target="_blank" rel="noopener">滥用Exchange：远离域管理员的一个API调用</a></p>
<p>[8] <a href="https://wiki.samba.org/index.php/The_SYSTEM_Account" target="_blank" rel="noopener">The SYSTEM Account</a></p>
<p>[9] <a href="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html#generic-dacl-abuse" target="_blank" rel="noopener">Wagging the Dog: Abusing Resource-Based Constrained Delegation to Attack Active Directory</a></p>

        </div>
        <!-- 文章结尾添加版权声明 从这里开始 -->
        
        <ul class="post-copyright">
        <li><strong>本文标题：</strong><a href="https://jontsang.github.io/post/ee2ffad8.html">结合CVE-2019-1040漏洞的两种Windows域提权利方式</a></li>
        <li><strong>本文作者：</strong><a href="https://jontsang.github.io">Jon Tsang</a></li>
        <!-- <li><strong>本文链接：</strong><a href="https://jontsang.github.io/post/ee2ffad8.html">https://jontsang.github.io/post/ee2ffad8.html</a></li> -->
        <li><strong>发布时间：</strong>2019-07-01</li>
        <li><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li>
        </ul>
        
        <!-- 文章结尾添加版权声明 到这里结束 -->
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/NTML/">NTML</a>, <a class="has-link-grey -link" href="/tags/Windows/">Windows</a>, <a class="has-link-grey -link" href="/tags/提权/">提权</a>, <a class="has-link-grey -link" href="/tags/漏洞/">漏洞</a>
                </div>
            </div>
        </div>
        
        
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190822175230.jpg" alt="支付宝"></div>
</a>

                
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="https://raw.githubusercontent.com/JonTsang/Figurebed/master/img/20190822175230.jpg" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/post/15753.html">
                <span class="level-item">图片隐写信息快速检测工具——zsteg</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="title is-5 has-text-weight-normal">评论</h3>
        
<div id="valine-thread" class="content"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#valine-thread' ,
        notify: true,
        verify: false,
        app_id: '2oTcdkk2ubE6P9DwKwwTTlDK-gzGzoHsz',
        app_key: 'z1TMyiu5W0zvLI3qKElhM6uU',
        placeholder: '不用注册也可以评论哟~支持Markdown~'
    });
</script>

    </div>
</div>
</div>
                




<div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left is-sticky">
    
        
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#漏洞复现">
        <span class="has-mr-6">1</span>
        <span>漏洞复现</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#攻击方式一：利用Exchange">
        <span class="has-mr-6">1.1</span>
        <span>攻击方式一：利用Exchange</span>
        </a></li><li>
        <a class="is-flex" href="#攻击方式二：利用Kerberos委派">
        <span class="has-mr-6">1.2</span>
        <span>攻击方式二：利用Kerberos委派</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#攻击流程和技术细节">
        <span class="has-mr-6">2</span>
        <span>攻击流程和技术细节</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#Exchange攻击流程细节">
        <span class="has-mr-6">2.1</span>
        <span>Exchange攻击流程细节</span>
        </a></li><li>
        <a class="is-flex" href="#Kerberos委派攻击流程">
        <span class="has-mr-6">2.2</span>
        <span>Kerberos委派攻击流程</span>
        </a></li><li>
        <a class="is-flex" href="#技术点分析">
        <span class="has-mr-6">2.3</span>
        <span>技术点分析</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#客户端与服务器端的SMB通信">
        <span class="has-mr-6">2.3.1</span>
        <span>客户端与服务器端的SMB通信</span>
        </a></li><li>
        <a class="is-flex" href="#SpoolService-printer-bug">
        <span class="has-mr-6">2.3.2</span>
        <span>SpoolService/printer bug</span>
        </a></li><li>
        <a class="is-flex" href="#SMB中继LDAP思路以及难点">
        <span class="has-mr-6">2.3.3</span>
        <span>SMB中继LDAP思路以及难点</span>
        </a></li><li>
        <a class="is-flex" href="#MIC校验">
        <span class="has-mr-6">2.3.4</span>
        <span>MIC校验</span>
        </a></li><li>
        <a class="is-flex" href="#MIC校验绕过">
        <span class="has-mr-6">2.3.5</span>
        <span>MIC校验绕过</span>
        </a></li><li>
        <a class="is-flex" href="#LDAP签名绕过">
        <span class="has-mr-6">2.3.6</span>
        <span>LDAP签名绕过</span>
        </a></li><li>
        <a class="is-flex" href="#smb中继LDAP流程">
        <span class="has-mr-6">2.3.7</span>
        <span>smb中继LDAP流程</span>
        </a></li></ul></li></ul></li><li>
        <a class="is-flex" href="#参考链接">
        <span class="has-mr-6">3</span>
        <span>参考链接</span>
        </a></li></ul>
        </div>
    </div>
</div>

    
    
        <div class="column-right-shadow is-hidden-widescreen is-sticky">
        
        </div>
    
</div>

                
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/logo.svg" alt="结合CVE-2019-1040漏洞的两种Windows域提权利方式" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Jon Tsang&nbsp;
                <!--Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>-->
                
                <br>
                <span id="busuanzi_container_site_uv">
                共<span id="busuanzi_value_site_uv">0</span>个访客
                </span>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>

<script>
var IcarusThemeSettings = {
    article: {
        highlight: {
            clipboard: true,
            fold: 'unfolded'
        }
    }
};
</script>


    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>



    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    

    


<script src="/js/main.js" defer></script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>